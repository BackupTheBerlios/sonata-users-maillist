<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Sonata-users] [PATCH] version: migrate to git version generation
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/sonata-users/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:sonata-users%40lists.berlios.de?Subject=Re%3A%20%5BSonata-users%5D%20%5BPATCH%5D%20version%3A%20migrate%20to%20git%20version%20generation&In-Reply-To=%3C1253654481-20729-1-git-send-email-bebarino%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001163.html">
   <LINK REL="Next"  HREF="001166.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Sonata-users] [PATCH] version: migrate to git version generation</H1>
    <B>Stephen Boyd</B> 
    <A HREF="mailto:sonata-users%40lists.berlios.de?Subject=Re%3A%20%5BSonata-users%5D%20%5BPATCH%5D%20version%3A%20migrate%20to%20git%20version%20generation&In-Reply-To=%3C1253654481-20729-1-git-send-email-bebarino%40gmail.com%3E"
       TITLE="[Sonata-users] [PATCH] version: migrate to git version generation">bebarino at gmail.com
       </A><BR>
    <I>Tue Sep 22 23:21:21 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001163.html">[Sonata-users] svn to git transition complete
</A></li>
        <LI>Next message: <A HREF="001166.html">[Sonata-users] [PATCH] main: fix centering of current song in	current playlist
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1165">[ date ]</a>
              <a href="thread.html#1165">[ thread ]</a>
              <a href="subject.html#1165">[ subject ]</a>
              <a href="author.html#1165">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Migrate the svn version generation code to git. In the process, simplify
the logic so the first try is the build generated file. If that
fails, try the git describe method and finally fallback to the default
version.
---
 setup.py             |   12 ++++++------
 sonata.py            |   17 +++++++----------
 sonata/cli.py        |    7 ++-----
 sonata/consts.py     |    5 -----
 sonata/main.py       |    9 +++------
 sonata/svnversion.py |   44 --------------------------------------------
 sonata/version.py    |   33 +++++++++++++++++++++++++++++++++
 7 files changed, 51 insertions(+), 76 deletions(-)
 delete mode 100644 sonata/svnversion.py
 create mode 100644 sonata/version.py

diff --git a/setup.py b/setup.py
index 8de28eb..44809ed 100644
--- a/setup.py
+++ b/setup.py
@@ -4,7 +4,7 @@ import os, glob, shutil
 
 from distutils.core import setup, Extension
 
-import sonata.svnversion
+from sonata.version import version
 
 def capture(cmd):
     return os.popen(cmd).read().strip()
@@ -47,15 +47,15 @@ for lang in ('de', 'pl', 'ru', 'fr', 'zh_CN', 'sv', 'es', 'fi', 'uk', 'it', 'cs'
 # Copy script &quot;sonata&quot; file to sonata dir:
 shutil.copyfile(&quot;sonata.py&quot;, &quot;sonata/sonata&quot;)
 
-versionfile = file(&quot;sonata/version.py&quot;,&quot;wt&quot;)
+versionfile = open(&quot;sonata/genversion.py&quot;,&quot;wt&quot;)
 versionfile.write(&quot;&quot;&quot;
 # generated by setup.py
-VERSION = %r
-&quot;&quot;&quot; % sonata.svnversion.VERSION)
+VERSION = 'v%s'
+&quot;&quot;&quot; % version)
 versionfile.close()
 
 setup(name='Sonata',
-        version=sonata.svnversion.VERSION,
+        version=version,
         description='GTK+ client for the Music Player Daemon (MPD).',
         author='Scott Horowitz',
         author_email='<A HREF="https://lists.berlios.de/mailman/listinfo/sonata-users">stonecrest at gmail.com</A>',
@@ -131,6 +131,6 @@ try:
 except:
     pass
 try:
-    os.remove(&quot;sonata/version.py&quot;)
+    os.remove(&quot;sonata/genversion.py&quot;)
 except:
     pass
diff --git a/sonata.py b/sonata.py
index e612acc..b9b7568 100755
--- a/sonata.py
+++ b/sonata.py
@@ -38,17 +38,14 @@ except ImportError:
     sys.exit(1)
 
 try:
-    import sonata.version as version
+    from sonata.version import version
 except ImportError:
-    try:
-        import sonata.svnversion as version
-    except ImportError:
-        sys.stderr.write(&quot;Python failed to find the sonata modules.\n&quot;)
-        sys.stderr.write(&quot;\nAn old or incomplete installation was &quot; +
-                 &quot;found in the following directory:\n&quot; +
-                 os.path.dirname(sonata.__file__) + &quot;\n&quot;)
-        sys.stderr.write(&quot;\nPerhaps you want to delete it?\n&quot;)
-        sys.exit(1)
+    sys.stderr.write(&quot;Python failed to find the sonata modules.\n&quot;)
+    sys.stderr.write(&quot;\nAn old or incomplete installation was &quot; +
+             &quot;found in the following directory:\n&quot; +
+             os.path.dirname(sonata.__file__) + &quot;\n&quot;)
+    sys.stderr.write(&quot;\nPerhaps you want to delete it?\n&quot;)
+    sys.exit(1)
 
 # XXX check that version.VERSION is what this script was installed for
 
diff --git a/sonata/cli.py b/sonata/cli.py
index 978ef93..7e0f0e4 100644
--- a/sonata/cli.py
+++ b/sonata/cli.py
@@ -3,10 +3,7 @@ import sys
 import gettext
 from optparse import OptionParser
 
-try:
-    import version
-except ImportError:
-    import svnversion as version
+from version import version
 
 # the mpd commands need a connection to server and exit without gui
 mpd_cmds = [&quot;play&quot;, &quot;pause&quot;, &quot;stop&quot;, &quot;next&quot;, &quot;prev&quot;, &quot;pp&quot;, &quot;info&quot;,
@@ -40,7 +37,7 @@ class Args(object):
         &quot;  info            %s&quot; % _(&quot;display current song info&quot;),
         &quot;  status          %s&quot; % _(&quot;display MPD status&quot;),
         ))
-        _version = &quot;%prog &quot; + version.VERSION
+        _version = &quot;%prog &quot; + version
 
         parser = OptionParser(usage=_usage, version=_version)
         parser.add_option(&quot;-p&quot;, &quot;--popup&quot;, dest=&quot;popup&quot;,
diff --git a/sonata/consts.py b/sonata/consts.py
index 7bf8107..8e54a49 100644
--- a/sonata/consts.py
+++ b/sonata/consts.py
@@ -18,11 +18,6 @@ if view == consts.VIEW_ALBUM: ...
 class Constants:
     &quot;&quot;&quot;This class contains the constant definitions as attributes.&quot;&quot;&quot;
     def __init__(self):
-        try:
-            self.HEAD_URL = &quot;$HeadURL$&quot;.split()[1][:-len(&quot;/sonata/consts.py&quot;)]
-        except IndexError: # svn internal files don't have the url
-            self.HEAD_URL = &quot;&quot;
-
         self.ART_LOCAL = 0
         self.ART_LOCAL_REMOTE = 1
         self.VIEW_FILESYSTEM = 0
diff --git a/sonata/main.py b/sonata/main.py
index 2879c16..363f102 100644
--- a/sonata/main.py
+++ b/sonata/main.py
@@ -64,10 +64,7 @@ import lyricwiki # plug-ins
 import rhapsodycovers
 import dbus_plugin as dbus
 
-try:
-    import version
-except ImportError:
-    import svnversion as version
+from version import version
 
 class Base(object):
 
@@ -850,7 +847,7 @@ class Base(object):
             # Code thanks to quodlibet:
 
             # XXX gnome.init sets process name, locale...
-            gnome.init(&quot;sonata&quot;, version.VERSION)
+            gnome.init(&quot;sonata&quot;, version)
 
             misc.setlocale()
 
@@ -3127,7 +3124,7 @@ class Base(object):
         self.mpd_update_queued = True
 
     def on_about(self, _action):
-        about_dialog = about.About(self.window, self.config, version.VERSION, __license__, self.find_path('sonata_large.png'))
+        about_dialog = about.About(self.window, self.config, version, __license__, self.find_path('sonata_large.png'))
 
         stats = None
         if self.conn:
diff --git a/sonata/svnversion.py b/sonata/svnversion.py
deleted file mode 100644
index 652e542..0000000
--- a/sonata/svnversion.py
+++ /dev/null
@@ -1,44 +0,0 @@
-
-# in builds, the generated version module should be used instead
-
-import os, subprocess
-from xml.etree import ElementTree
-
-import sonata
-from consts import consts
-
-def find_svnrev():
-    dirname = os.path.dirname(os.path.dirname(sonata.__file__))
-
-    if not os.path.exists(os.path.join(dirname, '.svn')):
-        return &quot;exported&quot;
-
-    try:
-        output = subprocess.Popen([&quot;svnversion&quot;, dirname],
-                      stdout=subprocess.PIPE,
-                      stderr=subprocess.PIPE
-                      ).communicate()[0]
-        if output.strip():
-            return output.strip()
-    except OSError: # svnversion fails to run
-        pass # try next
-
-    try:
-        output = subprocess.Popen([&quot;svn&quot;, &quot;info&quot;, &quot;--xml&quot;, dirname],
-                      stdout=subprocess.PIPE,
-                      stderr=subprocess.PIPE
-                      ).communicate()[0]
-        info = ElementTree.fromstring(output)
-        return info.find(&quot;entry&quot;).get(&quot;revision&quot;)
-    except (OSError, # svn fails to run
-        Exception, # no repo causes parsing svn info to fail
-        AttributeError): # no &lt;entry&gt; for some reason
-        pass # try next
-
-    return None
-
-if &quot;/tags/&quot; in consts.HEAD_URL:
-    VERSION = consts.HEAD_URL.split(&quot;/tags/&quot;)[1].split(&quot;/&quot;)[0]
-else:
-    revision = find_svnrev()
-    VERSION = &quot;svn%s&quot; % (revision if revision else &quot;????&quot;)
diff --git a/sonata/version.py b/sonata/version.py
new file mode 100644
index 0000000..6d96585
--- /dev/null
+++ b/sonata/version.py
@@ -0,0 +1,33 @@
+import os
+from subprocess import Popen, PIPE
+
+try:
+    import genversion
+    build_ver = genversion.VERSION
+except ImportError:
+    build_ver = None
+
+# Should be the most recent release
+default_version = &quot;v1.6.2.1&quot;
+
+def _version():
+    '''Get the version number of the sources
+
+    First check the build generated file, fallback to git describe if this is
+    not a build, finally fallback to the default most recent release.
+    '''
+    if build_ver:
+        version = build_ver
+    else:
+        try:
+            dir = os.path.dirname(__file__)
+            version = Popen([&quot;git&quot;, &quot;describe&quot;, &quot;--abbrev=4&quot;, &quot;HEAD&quot;],
+                             cwd=dir, stdout=PIPE,
+                             stderr=PIPE).communicate()[0]
+            if not version:
+                raise OSError
+        except OSError:
+            version = default_version
+    return version.strip()[1:]
+
+version = _version()
-- 
1.6.5.rc1.44.ga1675


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001163.html">[Sonata-users] svn to git transition complete
</A></li>
	<LI>Next message: <A HREF="001166.html">[Sonata-users] [PATCH] main: fix centering of current song in	current playlist
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1165">[ date ]</a>
              <a href="thread.html#1165">[ thread ]</a>
              <a href="subject.html#1165">[ subject ]</a>
              <a href="author.html#1165">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/sonata-users">More information about the Sonata-users
mailing list</a><br>
</body></html>
